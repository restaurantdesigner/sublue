<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <title>Scooter Sublue Navbow+</title>
  <link rel="icon" href="img/favi.png" type="image/png" />
  <meta name="description" content="Alquiler y venta del scooter submarino Sublue Navbow+ en España. Entrega rápida, asistencia personalizada y productos originales." />

  <style>
    @media (min-width: 1024px) {
      .site-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
        padding: 0 60px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
      }
      .site-header .logo {
        width: 140px;
        max-width: 100%;
      }
      .site-header nav {
        display: flex;
        gap: 40px;
      }
      .site-header nav a {
        font-family: 'Inter', sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
        opacity: 0.7;
        text-decoration: none;
        transition: opacity 0.3s;
      }
      .site-header nav a:hover {
        opacity: 1;
      }
    }
    .site-header {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 60px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      z-index: 1000;
    }
  </style>
</head>
<body class="bg-white text-gray-800">

<header class="site-header px-4 py-2 flex justify-between items-center bg-gray-900 bg-opacity-90">
  <div class="flex items-center">
    <a href="index.html">
      <img src="img/sublue.png" alt="SUBI Logo" class="logo w-28 md:w-32 lg:w-36" />
    </a>
  </div>
  <nav class="hidden md:flex space-x-8 text-white font-semibold text-sm tracking-widest uppercase">
    <a href="index.html#catalog" class="hover:text-yellow-300 transition">Modelos</a>
    <a href="#alquiler" class="hover:text-yellow-300 transition">Alquiler</a>
    <a href="#contact" class="hover:text-yellow-300 transition">Contacto</a>
    <a href="#nosotros" class="hover:text-yellow-300 transition">Sobre nosotros</a>
    <a href="#faq" class="hover:text-yellow-300 transition">FAQ</a>
  </nav>
  <a href="cart.html" class="relative">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white hover:text-yellow-300 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.5 6h13l-1.5-6M9 21h0M15 21h0"/>
    </svg>
    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
  </a>
</header>

<div class="max-w-7xl mx-auto px-4 py-6 pt-24">
  <div class="flex flex-col lg:flex-row gap-6">
    <div class="lg:w-1/2">
      <div class="flex flex-col lg:flex-row gap-3">
        <div id="thumbnailContainer" class="flex flex-row lg:flex-col gap-2 lg:mr-2 overflow-x-auto"></div>
        <div class="flex-1">
          <img id="mainImage" src="" alt="Imagen principal del producto" class="w-full h-auto rounded shadow" />
          <p class="text-center text-sm mt-2 text-blue-600 underline cursor-pointer">Haz click para ver en detalle</p>
        </div>
      </div>
    </div>

    <div class="lg:w-1/2 pb-28 lg:pb-0">
      <h1 class="text-base sm:text-lg md:text-xl font-semibold mb-2 leading-snug">Scooter Submarino Sublue Navbow+ – Potente, 2 colores, profundidad 45m</h1>

      <div class="flex items-center mt-1">
        <span class="text-yellow-500 text-base">★★★★★</span>
        <span class="text-blue-600 ml-2 text-sm">18 valoraciones</span>
      </div>

      <div class="text-2xl sm:text-3xl font-bold mt-2">€1649<sup class="text-base sm:text-lg">.00</sup></div>

      <div class="mt-4">
        <span class="font-semibold text-sm">Color:</span>
        <span id="colorName" class="text-sm ml-1">Naranja Llama</span>
      </div>

      <div class="flex gap-3 mt-2">
        <div id="colorNaranjaLlama" onclick="setColor('llama')" class="w-20 h-16 border rounded cursor-pointer ring-2 ring-blue-500">
          <img src="img/products/NavbowPlus/naranjallama/naranjallama1.webp" class="w-full h-full object-cover rounded" alt="Naranja Llama" />
          <p class="text-center text-xs font-semibold">Naranja Llama</p>
        </div>

        <div id="colorGrisFantasma" onclick="setColor('fantasma')" class="w-20 h-16 border rounded cursor-pointer">
          <img src="img/products/NavbowPlus/grisfantasma/grisfantasma1.webp" class="w-full h-full object-cover rounded" alt="Gris Fantasma" />
          <p class="text-center text-xs font-semibold">Gris Fantasma</p>
        </div>

        <div class="mt-4">
          <label for="quantityInput" class="font-semibold text-sm block mb-1">Cantidad:</label>
          <input type="number" id="quantityInput" value="1" min="1" class="border rounded px-2 py-1 w-24" />
        </div>
      </div>

      <p id="deliveryEstimate" class="text-green-600 font-semibold mt-4">Entrega estimada: <span class="delivery-date">...</span></p>
      <p id="stockInfo" class="text-sm mt-2 text-gray-700 font-semibold"></p>

      <ul class="list-disc list-inside mt-4 space-y-3 text-sm leading-relaxed">
        <li><strong>Alta potencia con doble motor</strong> – Velocidad máxima de 2.0 m/s y profundidad hasta 45 m.</li>
        <li><strong>Duración extendida de batería</strong> – Hasta 70 minutos de uso continuo, carga rápida en 3 horas.</li>
        <li><strong>Diseño ergonómico y resistente</strong> – Materiales premium y resistente al agua IPX8.</li>
        <li><strong>Montura para cámara</strong> – Compatible con cámaras deportivas populares.</li>
        <li><strong>Ligero y portátil</strong> – Peso aproximado de 4.2 kg, fácil de transportar.</li>
      </ul>

      <button onclick="addToCart(event)" class="mt-4 bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-3 px-4 w-full rounded shadow transition">Añadir al carrito</button>

      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <button onclick="payWithStripe()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 w-full rounded shadow transition">Pagar con tarjeta</button>
        <button class="bg-gray-800 hover:bg-black text-white font-semibold py-3 px-4 w-full rounded shadow transition">PayPal</button>
      </div>

      <div id="accesoriosSection" class="mt-6 border-t pt-6 transition-all duration-500">
        <h2 class="text-lg font-semibold mb-4">Combina bien con:</h2>

        <div class="flex items-center space-x-4 mb-6">
          <img src="img/products/accessories/mix_battery.webp" alt="Mix Batería" class="w-16 h-16 rounded object-cover" />
          <div>
            <p class="text-sm text-gray-500">Sublue</p>
            <p class="font-bold text-base">Mix Batería</p>
            <p class="text-gray-800 text-sm">€399,00</p>
          </div>
        </div>

        <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
          <p class="text-sm font-medium mb-4 flex items-center">
            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c.828 0 1.5-.672 1.5-1.5S12.828 5 12 5s-1.5.672-1.5 1.5S11.172 8 12 8zM12 14c.828 0 1.5-.672 1.5-1.5S12.828 11 12 11s-1.5.672-1.5 1.5S11.172 14 12 14zM12 20c.828 0 1.5-.672 1.5-1.5S12.828 17 12 17s-1.5.672-1.5 1.5S11.172 20 12 20z"/></svg>
            Agrega Más Paga Menos
          </p>

          <label class="flex items-center space-x-4">
            <input type="checkbox" class="form-checkbox accent-blue-600" onchange="toggleAccessory(this, 39900, 'Mix Batería', 'img/products/accessories/mix_battery.webp')" />
            <img src="img/products/accessories/mix_battery.webp" alt="Mix Batería" class="w-14 h-14 rounded object-cover" />
            <div>
              <p class="font-semibold text-sm">Mix Batería</p>
              <p class="text-gray-700 text-sm">€399,00</p>
            </div>
          </label>
        </div>

        <div class="mt-4 text-right">
          <p class="font-semibold text-base">Total adicional: <span id="accesoriosTotal">€0,00</span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white text-sm px-4 py-2 rounded shadow-lg hidden z-50 transition">Añadido al carrito</div>

<script>
  const stockData = {};

  const productImagesByColor = {
    llama: [
      "img/products/NavbowPlus/naranjallama/naranjallama1.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama2.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama3.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama4.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama5.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama6.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama7.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama8.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama9.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama10.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama11.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama12.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama13.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama14.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama15.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama16.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama17.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama18.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama19.webp",
      "img/products/NavbowPlus/naranjallama/naranjallama20.webp"
    ],
    fantasma: [
      "img/products/NavbowPlus/grisfantasma/grisfantasma1.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma2.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma3.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma4.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma5.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma6.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma7.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma8.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma9.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma10.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma11.webp",
      "img/products/NavbowPlus/grisfantasma/grisfantasma12.webp"
    ]
  };

  let selectedColor = "Naranja Llama";
  let currentColor = "llama";

  let currentIndex = 0;
  let accesoriosSeleccionados = [];
  let startX = 0;

  function handleTouchStart(e) {
    startX = e.touches[0].clientX;
  }

  function handleTouchEnd(e) {
    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;
    const images = productImagesByColor[currentColor];
    if (!images) return;

    if (Math.abs(diff) > 50) {
      if (diff < 0 && currentIndex < images.length - 1) {
        currentIndex++;
      } else if (diff > 0 && currentIndex > 0) {
        currentIndex--;
      }
      document.getElementById("mainImage").src = images[currentIndex];

      const thumbnails = document.getElementById("thumbnailContainer").children;
      Array.from(thumbnails).forEach((thumb, i) => {
        thumb.classList.toggle("ring-2", i === currentIndex);
        thumb.classList.toggle("ring-blue-500", i === currentIndex);
      });
    }
  }

  
  function updateColorBorder() {
  const llamaBox = document.getElementById("colorNaranjaLlama");
  const fantasmaBox = document.getElementById("colorGrisFantasma");

  if (!llamaBox || !fantasmaBox) return;

  llamaBox.classList.remove("ring-2", "ring-blue-500");
  fantasmaBox.classList.remove("ring-2", "ring-blue-500");

  if (currentColor === "llama") {
  llamaBox.classList.add("ring-2", "ring-blue-500");
} else if (currentColor === "fantasma") {
  fantasmaBox.classList.add("ring-2", "ring-blue-500");
}

}
  function setColor(color) {
  const images = productImagesByColor[color];
  console.log('setColor called with:', color);
  console.log('Images:', images);
  if (!images) {
    console.error('No images found for color:', color);
    return;
  }

  currentColor = color;
  currentIndex = 0;
  selectedColor = color === "llama" ? "Naranja Llama" : "Gris Fantasma";

  const mainImage = document.getElementById("mainImage");
  const thumbnails = document.getElementById("thumbnailContainer");
  document.getElementById("colorName").textContent = selectedColor;

  mainImage.src = images[0];
  thumbnails.innerHTML = "";

  images.forEach((img, index) => {
    const thumb = document.createElement("img");
    thumb.src = img;
    thumb.className = "w-14 h-14 object-cover border rounded cursor-pointer hover:ring-2 hover:ring-blue-500";
    if (index === 0) {
      thumb.classList.add("ring-2", "ring-blue-500");
    }
    thumb.onmouseover = () => {
      mainImage.src = img;
    };
    thumb.onclick = () => {
      const allThumbs = document.querySelectorAll("#thumbnailContainer img");
      allThumbs.forEach(t => t.classList.remove("ring-2", "ring-blue-500"));
      mainImage.src = img;
      currentIndex = index;
      thumb.classList.add("ring-2", "ring-blue-500");
    };
    thumbnails.appendChild(thumb);
  });

  updateStockInfo();
  updateColorBorder();
}


  async function loadStock() {
    try {
      const response = await fetch(
  "https://docs.google.com/spreadsheets/d/1oFM818LNbAgwb-SQBZxmH2UaG2RJQg1nFJymO7THpDw/export?format=csv&gid=0&t=" + Date.now(),
  { cache: "no-store" }
);

      const csvText = await response.text();
      const lines = csvText.split("\n").slice(1);

      lines.forEach(line => {
        const cells = line.split(",");
        const id = cells[0]?.trim();
        const stock = parseInt(cells[4]?.trim());

        if (id && !isNaN(stock)) {
          stockData[id] = stock;
        }
      });

      updateStockInfo();
    } catch (err) {
      console.error("Error loading stock:", err);
    }
  }

  function updateStockInfo() {
    const productId = "navbowplus_" + currentColor;
    const stock = stockData[productId] ?? 0;

    const stockEl = document.getElementById("stockInfo");
    if (stockEl) {
      stockEl.textContent = stock > 0
        ? `En stock: ${stock} unidad${stock === 1 ? "" : "es"}`
        : "❌ No disponible";
    }

    const btn = document.querySelector("button[onclick='addToCart(event)']");
    if (btn) {
      btn.disabled = stock === 0;
      btn.classList.toggle("opacity-50", stock === 0);
      btn.classList.toggle("cursor-not-allowed", stock === 0);
    }
  }

  function addToCart(event) {
    event.stopPropagation();

    const quantity = parseInt(document.getElementById("quantityInput").value) || 1;
    const mainImage = document.getElementById("mainImage").src;

    const mainItem = {
      id: "navbowplus_" + currentColor,
      name: "Sublue Navbow+",
      color: selectedColor,
      price: 1649,
      qty: quantity,
      image: mainImage,
      delivery: getDeliveryDate()
    };

    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    const existing = cart.find(
      p => p.id === mainItem.id && p.color === mainItem.color && p.image === mainItem.image
    );

    const alreadyInCart = existing ? existing.qty : 0;
    const totalRequested = alreadyInCart + quantity;
    const availableStock = stockData[mainItem.id] || 0;

    if (totalRequested > availableStock) {
      alert(`Lo sentimos, solo quedan ${availableStock} unidades. Ya tienes ${alreadyInCart} en el carrito.`);
      return;
    }

    if (existing) {
      existing.qty += quantity;
    } else {
      cart.push(mainItem);
    }

    accesoriosSeleccionados.forEach(accessory => {
      const found = cart.find(p => p.id === accessory.id);
      if (!found) cart.push({ ...accessory });
    });

    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
    showToast("Añadido al carrito");
  }

  async function payWithStripe() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    if (cart.length === 0) {
      alert("¡Tu carrito está vacío!");
      return;
    }

    const items = cart.map(item => ({
      id: item.id,
      name: item.name + (item.color ? ` - ${item.color}` : ""),
      description: item.description || "Producto Sublue",
      price: Number(item.price),
      quantity: item.qty || 1,
      image: item.image
    }));

    try {
      const response = await fetch("http://192.168.1.118:4242/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items })
      });

      const data = await response.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert("Error: " + data.error);
      }
    } catch (error) {
      alert("Error al crear la sesión de pago: " + error.message);
    }
  }

  function toggleAccessory(checkbox, price, name, image) {
    const item = {
      id: "acc_" + name.toLowerCase().replace(/\s+/g, "_"),
      name,
      description: "Accesorio adicional",
      price,
      quantity: 1,
      image
    };

    if (checkbox.checked) {
      accesoriosSeleccionados.push(item);
    } else {
      accesoriosSeleccionados = accesoriosSeleccionados.filter(i => i.id !== item.id);
    }

    updateAccessoryTotal();
  }

  function updateAccessoryTotal() {
    const total = accesoriosSeleccionados.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const totalText = (total / 100).toFixed(2).replace(".", ",");
    document.getElementById("accesoriosTotal").textContent = `€${totalText}`;
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 3000);
  }

  function updateCartCount() {
    try {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const totalQty = cart.reduce((sum, item) => sum + (parseInt(item.qty) || 0), 0);
      const countEl = document.getElementById("cartCount");
      if (countEl) {
        countEl.textContent = totalQty > 0 ? totalQty : "";
        countEl.classList.toggle("hidden", totalQty === 0);
      }
    } catch (e) {
      console.error("Error loading cart:", e);
    }
  }

  function getDeliveryDate() {
    const now = new Date();
    now.setDate(now.getDate() + 7);
    return now.toLocaleDateString("es-ES");
  }

  window.onload = async () => {
    await loadStock();
    setColor("llama");
    updateCartCount();
    updateStockInfo();

    const dateEl = document.querySelector(".delivery-date");
    if (dateEl) {
      dateEl.textContent = getDeliveryDate();
    }

    const img = document.getElementById("mainImage");
    img.addEventListener("touchstart", handleTouchStart, false);
    img.addEventListener("touchend", handleTouchEnd, false);
  };
</script>

</body>
</html>
