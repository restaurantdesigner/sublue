<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Alquiler y venta de scooters submarinos Sublue en Espa√±a. Entrega r√°pida, asistencia personalizada y productos originales.">
  <link rel="icon" href="img/favi.png" type="image/png">
  <title>Scooters Sublue | Alquiler y Venta</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-white text-gray-800">

  <!-- ‚úÖ HEADER –ö–û–ü–ò–Ø –ò–ó MIXPRO -->
<header class="site-header px-4 py-2 flex justify-between items-center bg-gray-900 bg-opacity-90">

  <!-- –õ–û–ì–û –°–õ–ï–í–ê -->
  <div class="flex items-center">
    <a href="index.html">
      <img src="img/sublue.png" alt="SUBI Logo" class="logo w-28 md:w-32 lg:w-36" />
    </a>
  </div>

  <!-- –ú–ï–ù–Æ –°–ü–†–ê–í–ê: —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ -->
  <nav class="hidden md:flex space-x-8 text-white font-semibold text-sm tracking-widest uppercase">
    <a href="index.html#catalog" class="hover:text-yellow-300 transition">Modelos</a>
    <a href="#alquiler" class="hover:text-yellow-300 transition">Alquiler</a>
    <a href="#contact" class="hover:text-yellow-300 transition">Contacto</a>
    <a href="#nosotros" class="hover:text-yellow-300 transition">Sobre nosotros</a>
    <a href="#faq" class="hover:text-yellow-300 transition">FAQ</a>
  </nav>

  <!-- –ò–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
  <a href="cart.html" class="relative">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white hover:text-yellow-300 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.5 6h13l-1.5-6M9 21h0M15 21h0" />
    </svg>
    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
  </a>

</header>
<style>
  @media (min-width: 1024px) {
    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
      padding: 0 60px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
    }

    .site-header .logo {
      width: 140px;
      max-width: 100%;
    }

    .site-header nav {
      display: flex;
      gap: 40px;
    }

    .site-header nav a {
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: white;
      opacity: 0.7;
      text-decoration: none;
      transition: opacity 0.3s;
    }

    .site-header nav a:hover {
      opacity: 1;
    }
  }

  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    z-index: 1000;
  }

body {
  padding-top: 100px; /* —á—Ç–æ–±—ã –≤—Å—ë —Å–º–µ—Å—Ç–∏–ª–æ—Å—å –Ω–∏–∂–µ header */
}

  
</style>



  <main class="max-w-4xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-6">Tu carrito</h1>
    <div id="cartContainer" class="space-y-6"></div>

    <div class="mt-8 text-right">
      <p class="text-xl font-bold mb-2">Total: <span id="cartTotal">‚Ç¨0.00</span></p>
      <button onclick="checkout()" class="bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-3 px-6 rounded shadow">CONFIRMAR PEDIDO</button>
    </div>
  </main>

  <script>

let stockData = {};




    function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const totalQty = cart.reduce((sum, item) => {
    const quantity = parseInt(item.qty || item.quantity || 0);
    return sum + (isNaN(quantity) ? 0 : quantity);
  }, 0);

  const countEl = document.getElementById("cartCount");
  if (countEl) {
    countEl.textContent = totalQty;
  }
}
// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  updateCartCount();

    function renderCart() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const container = document.getElementById("cartContainer");
      const totalEl = document.getElementById("cartTotal");

      container.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        container.innerHTML = "<p>Tu carrito est√° vac√≠o.</p>";
        totalEl.textContent = "‚Ç¨0.00";
        return;
      }

      cart.forEach((item, index) => {
        total += item.price * item.qty;

        const div = document.createElement("div");
        div.className = "flex items-center border-b pb-4";

        div.innerHTML = `
          <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4" />

          <div class="flex-1">
            <h2 class="text-lg font-semibold">${item.name}</h2>
            <p class="text-sm text-gray-600">Cantidad: ${item.qty}</p>
            <p class="text-sm text-gray-600">Subtotal: ‚Ç¨${(item.price * item.qty).toFixed(2)}</p>
          <p class="text-sm text-green-600 font-semibold">Entrega GRATIS estimada: ${item.delivery}</p>

          </div>
          <button onclick="removeItem(${index})" class="text-red-500 font-bold hover:underline">Eliminar</button>
        `;

        container.appendChild(div);
      });

      totalEl.textContent = "‚Ç¨" + total.toFixed(2);
    }

    function removeItem(index) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }

    async function checkout() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];

  if (cart.length === 0) {
    alert("Tu carrito est√° vac√≠o");
    return;
  }

  const items = cart.map(item => ({
  id: item.id, // üî• –î–æ–±–∞–≤–ª–µ–Ω–æ!
  name: item.name + (item.color ? ` - ${item.color}` : ""),
  description: item.description || "Producto Sublue",
  price: Number(item.price),
  quantity: item.qty || 1,
  image: item.image
}));

  // üîé –û—Ç–ª–∞–¥–∫–∞
  console.log("üõí Items enviados a Stripe:", items);

  // üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ item
  items.forEach((item, i) => {
    if (!item.name || isNaN(item.price) || !item.quantity) {
      console.warn(`‚ö†Ô∏è Problema con el √≠tem #${i + 1}:`, item);
    }
  });

  try {
    const response = await fetch("http://localhost:4242/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items })
    });

    const data = await response.json();

    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("Error en el pago: " + data.error);
    }
  } catch (err) {
    alert("Fallo al crear sesi√≥n de pago: " + err.message);
  }
}




    renderCart();
    updateCartCount();
    loadStock();
function validateCartAgainstStock() {
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let updated = false;

  cart = cart.map(item => {
    const availableStock = stockData[item.id] ?? 0;

    // –ï—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ –±–æ–ª—å—à–µ, —á–µ–º –≤ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–º
    if (item.qty > availableStock) {
      item.qty = availableStock;
      updated = true;
    }

    return item;
  });

  localStorage.setItem("cart", JSON.stringify(cart));

  if (updated) {
    showToast("üîÑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ –Ω–∞–ª–∏—á–∏—é");
  }

  updateCartCount?.();
}

async function loadStock() {
  const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_8DRtvqhfTcNQq5cgiAAZSf7lKv7N2Q-B4XbAJwe_hRz4W8CET4LPn16Qo4oZ1M_RF_XfW3JmTl-/pub?gid=0&single=true&output=csv&t=" + Date.now());
  const csvText = await response.text();
  const lines = csvText.split('\n').slice(1);

  lines.forEach(line => {
    const cells = line.split(',');
    const id = cells[0]?.trim();
    const stock = parseInt(cells[4]?.trim());
    if (id && !isNaN(stock)) {
      stockData[id] = stock;
    }
  });

  validateCartAgainstStock(); // ‚úÖ —Å–≤–µ—Ä–∏–º –∫–æ—Ä–∑–∏–Ω—É
}
function showToast(message) {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.className = "fixed bottom-5 right-5 bg-green-600 text-white text-sm px-4 py-2 rounded shadow z-50";
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}


  </script>

</body>
</html>
